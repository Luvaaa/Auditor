# FastAPI-specific patterns
patterns:
  - name: "fastapi-sync-in-async-route"
    description: "Synchronous operation in async FastAPI route"
    regex: "async\\s+def\\s+\\w+.*?\\n[^}]*\\b(time\\.sleep|requests\\.|urllib\\.)\\b"
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-missing-dependency-injection"
    description: "Direct database access without dependency injection"
    regex: "@(app\\.get|app\\.post|router\\.get|router\\.post).*\\n[^}]*\\b(db\\.|session\\.|conn\\.)\\b(?!.*Depends)"
    languages: ["python"]
    severity: "medium"
    
  - name: "fastapi-unvalidated-path-param"
    description: "Path parameter used directly without validation"
    regex: "\\{(\\w+)\\}.*?def\\s+\\w+\\([^)]*\\1[^:]*\\):"
    languages: ["python"]
    severity: "medium"
    
  - name: "fastapi-missing-cors"
    description: "FastAPI app without CORS middleware"
    regex: "FastAPI\\((?!.*CORSMiddleware)"
    languages: ["python"]
    severity: "low"
    
  - name: "fastapi-blocking-file-operation"
    description: "Blocking file I/O in async route"
    regex: "async\\s+def.*?\\n[^}]*\\bopen\\([^)]*\\)(?!.*aiofiles)"
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-sql-in-route"
    description: "Raw SQL query in route handler"
    regex: "@(app|router)\\.(get|post|put|delete).*?def.*?\\n[^}]*(SELECT|INSERT|UPDATE|DELETE)\\s+"
    languages: ["python"]
    severity: "high"
    ast_pattern:
      node_type: "function_definition"
      contains: ["SELECT", "INSERT", "UPDATE", "DELETE"]
    
  - name: "fastapi-background-task-exception"
    description: "Background task without exception handling - unhandled exceptions in background tasks fail silently"
    regex: "BackgroundTasks\\(\\).*?\\.add_task\\([^)]+\\)(?!.*try.*except)"
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-unsafe-depends-injection"
    description: "Dependency injection without validation - potential for unsafe dependency resolution"
    regex: "Depends\\(lambda[^:]*:[^)]*request\\."
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-websocket-no-auth"
    description: "WebSocket endpoint without authentication - unprotected real-time communication channel"
    regex: "@(app|router)\\.websocket\\([^)]+\\).*?async\\s+def\\s+\\w+\\([^)]*\\)(?!.*(?:token|auth|verify|check_permission))"
    languages: ["python"]
    severity: "critical"
    
  - name: "fastapi-missing-request-validation"
    description: "Endpoint without Pydantic model validation - raw dict/Any types allow unvalidated input"
    regex: "async\\s+def\\s+\\w+\\([^)]*(?:dict|Dict\\[|Any)(?!.*BaseModel)"
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-exposed-debug-endpoint"
    description: "Debug/test endpoint exposed in production - information disclosure risk"
    regex: "@(app|router)\\.(get|post)\\(['\"`]/(?:debug|test|health/full|metrics/internal)['\"`]"
    languages: ["python"]
    severity: "high"
    
  - name: "fastapi-unhandled-startup-error"
    description: "Startup event without error handling - app fails to start on initialization errors"
    regex: "@app\\.on_event\\(['\"`]startup['\"`]\\).*?async\\s+def[^{]*\\{(?!.*try.*except)"
    languages: ["python"]
    severity: "medium"
    
  - name: "fastapi-stream-response-no-timeout"
    description: "StreamingResponse without timeout - potential for resource exhaustion"
    regex: "StreamingResponse\\([^)]+\\)(?!.*timeout)"
    languages: ["python"]
    severity: "medium"
    
  - name: "fastapi-form-data-injection"
    description: "Form data used in file operations - potential path traversal vulnerability"
    regex: "Form\\(\\).*?(?:open|Path)\\([^)]*\\w+[^)]*\\)"
    languages: ["python"]
    severity: "critical"
    
  - name: "fastapi-middleware-order-issue"
    description: "Security middleware added after routes - middleware won't protect existing routes"
    regex: "app\\.include_router\\(.*?\\n.*?app\\.add_middleware\\("
    languages: ["python"]
    severity: "high"
